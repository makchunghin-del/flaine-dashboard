<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Flaine & Grand Massif Snowboard Dashboard</title>

<style>
:root{
  --bg:#eef2f7; --card:#ffffff; --text:#0b1220; --muted:#5b6575;
  --brand:#0c3b66; --brand2:#0a2f52;
  --ok:#0f7b3a; --warn:#b26a00;
  --ring: rgba(12,59,102,.18);
  --shadow: 0 10px 22px rgba(0,0,0,.08);
}
body.dark{
  --bg:#0b1220; --card:#0f172a; --text:#e8eefc; --muted:#a9b4c7;
  --ring: rgba(148,163,184,.18);
  --shadow: 0 10px 22px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}

.topbar{position:sticky;top:0;z-index:10;background:linear-gradient(90deg,var(--brand),var(--brand2));color:#fff;padding:14px 16px}
.topbar-row{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
.btn{border:none;border-radius:999px;padding:10px 12px;background:rgba(255,255,255,.14);color:#fff;font-weight:800;cursor:pointer}

.wrap{padding:14px;max-width:1200px;margin:auto}
.grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}

.card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);border:1px solid var(--ring)}
.card-h{padding:12px 14px;display:flex;justify-content:space-between;align-items:center}
.card-b{padding:12px 14px}

.badge{border:1px solid var(--ring);border-radius:999px;padding:6px 10px;font-weight:800;font-size:.8rem}
.badge.ok{color:var(--ok)} .badge.warn{color:var(--warn)}

.tiles{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.tile{padding:12px;border-radius:14px;border:1px solid var(--ring);background:rgba(12,59,102,.06)}
body.dark .tile{background:rgba(148,163,184,.07)}
.tile .k{font-size:.8rem;color:var(--muted)}
.tile .v{font-size:1.25rem;font-weight:900}

iframe{width:100%;border:1px solid var(--ring);border-radius:14px;background:#fff}

.pdfwrap{border:1px solid var(--ring);border-radius:14px;overflow:hidden}
.pdfbar{display:flex;justify-content:space-between;gap:8px;padding:10px;background:rgba(12,59,102,.06)}
.pdfbtn{border:1px solid var(--ring);border-radius:999px;padding:6px 10px;font-weight:900;background:transparent;cursor:pointer}
canvas{width:100%;display:block;background:#fff}
#pdfCanvas{touch-action:none;cursor:grab}
#pdfCanvas:active{cursor:grabbing}

.chk{display:flex;gap:10px;padding:10px;border:1px solid var(--ring);border-radius:14px}

.col-12{grid-column:span 12}
@media(max-width:860px){.tiles{grid-template-columns:1fr}}
</style>
</head>

<body>

<div class="topbar">
  <div class="topbar-row">
    <div>
      <strong>Flaine & Grand Massif</strong><br>
      <span style="font-size:.85rem;opacity:.9">Weather ‚Ä¢ Maps ‚Ä¢ Off-piste ‚Ä¢ Lift status</span>
    </div>
    <button class="btn" id="darkBtn">üåô Dark</button>
  </div>
</div>

<div class="wrap">
<div class="grid">

<!-- WEATHER HUD (SNOWBOARD DECISION VIEW: FLAINE + GM HIGH) -->
<div class="card col-12">
  <div class="card-h">
    <strong>Weather HUD (Flaine + Grand Massif)</strong>
    <span class="badge ok" id="wxStatus">Live</span>
  </div>
  <div class="card-b">

    <!-- Decision Bar -->
    <div class="tile" id="wxDecision" style="margin-bottom:10px">
      <div class="k" id="wxDecisionTitle">--</div>
      <div class="v" id="wxDecisionMain">--</div>
      <div class="k" id="wxDecisionSub" style="margin-top:6px">--</div>
    </div>

    <!-- Base vs High chips -->
    <div style="display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px;margin-bottom:10px">
      <div class="tile" style="padding:10px">
        <div class="k">Flaine (Base/Mid)</div>
        <div class="v" id="wxChipF">--</div>
        <div class="k" id="wxChipFSub" style="margin-top:4px">--</div>
      </div>
      <div class="tile" style="padding:10px">
        <div class="k">Grand Massif (High)</div>
        <div class="v" id="wxChipG">--</div>
        <div class="k" id="wxChipGSub" style="margin-top:4px">--</div>
      </div>
    </div>

    <!-- Next 6 hours micro-timeline -->
    <div class="tile" style="padding:10px">
      <div class="k">Next 6 hours (snow + gusts)</div>
      <div id="wxTimeline" style="display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:8px;margin-top:8px"></div>
      <div class="k" id="wxRideCall" style="margin-top:10px;font-weight:900">--</div>
    </div>

  </div>
</div>

<!-- PISTE MAP (PDF) -->
<div class="card col-12">
  <div class="card-h"><strong>Piste Map (PDF)</strong></div>
  <div class="card-b">
    <div class="pdfwrap">
      <div class="pdfbar">
        <span class="badge" id="pdfStatus">Loading‚Ä¶</span>
        <div>
          <button class="pdfbtn" id="prev">‚óÄ</button>
          <button class="pdfbtn" id="next">‚ñ∂</button>
          <button class="pdfbtn" id="zoomOut">Ôºç</button>
          <button class="pdfbtn" id="zoomIn">Ôºã</button>
          <button class="pdfbtn" id="fit">Fit</button>
          <a class="badge" href="GM_PlanPistes_25_26_HD_copy.pdf" target="_blank">Open PDF</a>
        </div>
      </div>
      <canvas id="pdfCanvas"></canvas>
    </div>
  </div>
</div>

<!-- OFF-PISTE -->
<div class="card col-12">
  <div class="card-h"><strong>Off-piste (community-known zones)</strong></div>
  <div class="card-b" id="offpisteList"></div>
</div>

<!-- OFFICIAL LIFT STATUS (LAST) -->
<div class="card col-12">
  <div class="card-h">
    <strong>Official Lift & Piste Status</strong>
    <span class="badge ok">Live</span>
  </div>
  <div class="card-b">

    <strong>Flaine ‚Äì Opening Status</strong>
    <iframe src="https://www.flaine.com/en/weather-opening/" loading="lazy" style="height:520px"></iframe>

    <div style="height:14px"></div>

    <strong>Grand Massif ‚Äì Lift & Piste Openings</strong>
    <iframe id="gmFrame"
      src="https://www.grand-massif.com/en/information-on-trail-openings/"
      loading="lazy"
      style="height:520px"></iframe>

    <div id="gmFallback" style="display:none;margin-top:10px">
      <a class="badge" target="_blank" href="https://www.grand-massif.com/en/information-on-trail-openings/">
        Open Grand Massif official lift & piste openings
      </a>
    </div>

  </div>
</div>

</div>
</div>

<script type="module">
import * as pdfjsLib from './pdf.mjs';
pdfjsLib.GlobalWorkerOptions.workerSrc = new URL('./pdf.worker.mjs', import.meta.url).toString();

const $ = id => document.getElementById(id);
$('darkBtn').onclick = () => document.body.classList.toggle('dark');

// Weather (Open-Meteo) ‚Äî Combined Flaine + Grand Massif
const FLAINE = { lat:46.001, lon:6.688, name:'Flaine' };
const GM_HIGH = { lat:46.022, lon:6.720, name:'Grand Massif (High)' };

async function fetchWeather(p){
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${p.lat}&longitude=${p.lon}&current=temperature_2m,wind_speed_10m,wind_gusts_10m&hourly=snowfall,wind_gusts_10m&timezone=auto`;
  const r = await fetch(url);
  return await r.json();
}

async function loadWeather(){
  try{
    const [f, g] = await Promise.all([
      fetchWeather(FLAINE),
      fetchWeather(GM_HIGH)
    ]);

    const sum = (arr)=>arr.reduce((a,b)=>a+b,0);
    const max = (arr)=>arr.reduce((a,b)=>Math.max(a,b), -Infinity);

    // Current
    const fTemp = Math.round(f.current.temperature_2m);
    const gTemp = Math.round(g.current.temperature_2m);
    const fWind = f.current.wind_speed_10m;
    const gWind = g.current.wind_speed_10m;
    const fGust = f.current.wind_gusts_10m;
    const gGust = g.current.wind_gusts_10m;

    // Forecast (next 6h + 12h/24h)
    const snowF12 = sum(f.hourly.snowfall.slice(0,12));
    const snowG12 = sum(g.hourly.snowfall.slice(0,12));
    const snowF24 = sum(f.hourly.snowfall.slice(0,24));
    const snowG24 = sum(g.hourly.snowfall.slice(0,24));

    const gustF6 = f.hourly.wind_gusts_10m.slice(0,6);
    const gustG6 = g.hourly.wind_gusts_10m.slice(0,6);

    // Combined view
    const minT = Math.min(fTemp, gTemp);
    const maxT = Math.max(fTemp, gTemp);
    const snow12 = Math.max(snowF12, snowG12);
    const snow24 = Math.max(snowF24, snowG24);

    // Wind risk (use GM High gust more heavily)
    const riskG = gGust;
    let riskLabel='Stable', riskEmoji='üü¢', riskCls='badge ok';
    if(riskG >= 12){ riskLabel='High (closures likely)'; riskEmoji='üî¥'; riskCls='badge warn'; }
    else if(riskG >= 8){ riskLabel='Moderate (upper lifts at risk)'; riskEmoji='üü†'; riskCls='badge warn'; }

    // Update status badge
    const st = document.getElementById('wxStatus');
    st.textContent = 'Live';
    st.className = riskCls;

    // Decision bar
    document.getElementById('wxDecisionTitle').textContent = `${riskEmoji} WIND RISK: ${riskLabel}`;
    document.getElementById('wxDecisionMain').textContent = `${minT}¬∞C ‚Üí ${maxT}¬∞C ¬∑ Gust ${riskG.toFixed(1)} m/s`;
    document.getElementById('wxDecisionSub').textContent =
      snow24 > 0 ? `Snow: ${snow12.toFixed(1)} mm (12h) ¬∑ ${snow24.toFixed(1)} mm (24h)` : `Snow: none expected (24h)`;

    // Chips
    document.getElementById('wxChipF').textContent = `${fTemp}¬∞C`;
    document.getElementById('wxChipFSub').textContent =
      `Wind ${fWind.toFixed(1)} ¬∑ Gust ${fGust.toFixed(1)} ¬∑ Snow ${snowF12.toFixed(1)}mm/12h`;

    document.getElementById('wxChipG').textContent = `${gTemp}¬∞C`;
    document.getElementById('wxChipGSub').textContent =
      `Wind ${gWind.toFixed(1)} ¬∑ Gust ${gGust.toFixed(1)} ¬∑ Snow ${snowG12.toFixed(1)}mm/12h`;

    // Timeline blocks (use the WORSE-case between the two for each hour)
    const tl = document.getElementById('wxTimeline');
    tl.innerHTML='';
    for(let i=0;i<6;i++){
      const snowH = Math.max(f.hourly.snowfall[i]||0, g.hourly.snowfall[i]||0);
      const gustH = Math.max(gustF6[i]||0, gustG6[i]||0);
      const b = document.createElement('div');
      b.style.border = '1px solid var(--ring)';
      b.style.borderRadius = '12px';
      b.style.padding = '8px';
      b.style.background = 'rgba(12,59,102,.06)';
      b.innerHTML = `<div style="font-weight:900">+${i+1}h</div>
        <div style="font-size:.9rem;color:var(--muted);margin-top:4px">üå®Ô∏è ${snowH.toFixed(1)} mm</div>
        <div style="font-size:.9rem;color:var(--muted)">üí® ${gustH.toFixed(1)} m/s</div>`;
      tl.appendChild(b);
    }

    // Ride call (simple rules)
    let call = 'Ride call: ';
    const snowGood = snow12 >= 5;
    const windy = riskG >= 8;
    if(snowGood && !windy) call += 'Alpine bowls window ‚Äî go high early.';
    else if(snowGood && windy) call += 'Fresh snow but windy ‚Äî trees recommended, watch upper closures.';
    else if(!snowGood && windy) call += 'Windy & no fresh ‚Äî stay lower, cruise pistes, plan early return.';
    else call += 'Stable day ‚Äî explore pistes; off-piste only if you know entries.';
    document.getElementById('wxRideCall').textContent = call;

  }catch(e){
    const st = document.getElementById('wxStatus');
    st.textContent='Unavailable';
    st.className='badge warn';
  }
}
loadWeather();

// GM iframe fallback
setTimeout(()=>{
  const f=$('gmFrame');
  try{
    if(!f.contentDocument || f.contentDocument.body.innerHTML.length<100){
      f.style.display='none';
      $('gmFallback').style.display='block';
    }
  }catch(e){
    f.style.display='none';
    $('gmFallback').style.display='block';
  }
},3000);

// Off-piste list
const zones=[
  {name:'Combe de Gers',desc:'High alpine bowl. Best with a guide.'},
  {name:'Lindars / V√©ret Bowls',desc:'Accessible side bowls near upper lifts.'},
  {name:'Trees toward Samo√´ns',desc:'Sheltered lines, good in low visibility.'},
  {name:'Trees toward Les Carroz',desc:'Sunny side, watch return timing.'}
];
const root=$('offpisteList');
zones.forEach(z=>{
  const d=document.createElement('div');
  d.className='chk';
  d.innerHTML=`<strong>${z.name}</strong><br><span style="color:var(--muted);font-size:.9rem">${z.desc}</span>`;
  root.appendChild(d);
});

// PDF
const PDF='GM_PlanPistes_25_26_HD_copy.pdf';
let pdf,page=1,scale=0.9,fit=true;
const DPR=Math.min(devicePixelRatio||1,1.5);
const canvas=$('pdfCanvas'),ctx=canvas.getContext('2d');
async function render(){
  const p=await pdf.getPage(page);
  const base=p.getViewport({scale:1});
  if(fit) scale=(canvas.parentElement.clientWidth/base.width)*0.98;
  const vp=p.getViewport({scale});
  canvas.width=vp.width*DPR; canvas.height=vp.height*DPR;
  canvas.style.width=vp.width+'px'; canvas.style.height=vp.height+'px';
  ctx.setTransform(DPR,0,0,DPR,0,0);
  await p.render({canvasContext:ctx,viewport:vp}).promise;
  $('pdfStatus').textContent='Ready';
}
async function loadPdf(){ pdf=await pdfjsLib.getDocument(PDF).promise; render(); }
$('prev').onclick=()=>{if(page>1){page--;render();}};
$('next').onclick=()=>{if(page<pdf.numPages){page++;render();}};
$('zoomIn').onclick=()=>{fit=false;scale+=0.15;render();};
$('zoomOut').onclick=()=>{fit=false;scale=Math.max(0.6,scale-0.15);render();};
$('fit').onclick=()=>{fit=true;render();};
setTimeout(loadPdf,300);

// ===== PDF PAN + DOUBLE-TAP ZOOM =====
let isDragging=false,startX=0,startY=0,offsetX=0,offsetY=0,lastTap=0;
const pdfEl=document.getElementById('pdfCanvas');

function applyPan(){
  pdfEl.style.transform=`translate(${offsetX}px, ${offsetY}px)`;
}

pdfEl.addEventListener('pointerdown',e=>{
  isDragging=true;
  startX=e.clientX-offsetX;
  startY=e.clientY-offsetY;
  pdfEl.setPointerCapture(e.pointerId);
});

pdfEl.addEventListener('pointermove',e=>{
  if(!isDragging) return;
  offsetX=e.clientX-startX;
  offsetY=e.clientY-startY;
  applyPan();
});

pdfEl.addEventListener('pointerup',e=>{
  isDragging=false;
  const now=Date.now();
  if(now-lastTap<300){
    fit=false;
    scale = scale < 1.6 ? scale + 0.6 : 0.9;
    offsetX=0; offsetY=0;
    applyPan();
    render();
  }
  lastTap=now;
});
</script>

</body>
</html>
```Ó®Å0Ó®Ç